name: watchdog-greenbone

services:
  vulnerability-tests:
    image: registry.community.greenbone.net/community/vulnerability-tests
    environment:
      FEED_RELEASE: ${FEED_RELEASE:-24.10}
      KEEP_ALIVE: "1"
    volumes:
      - vt_data_vol:/mnt
    healthcheck:
      test: ["CMD-SHELL", "test -n \"$(ls -A /mnt 2>/dev/null)\""]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 30s
    restart: unless-stopped

  notus-data:
    image: registry.community.greenbone.net/community/notus-data
    environment:
      FEED_RELEASE: ${FEED_RELEASE:-24.10}
      KEEP_ALIVE: "1"
    volumes:
      - notus_data_vol:/mnt
    healthcheck:
      test: ["CMD-SHELL", "test -n \"$(ls -A /mnt 2>/dev/null)\""]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 30s
    restart: unless-stopped

  scap-data:
    image: registry.community.greenbone.net/community/scap-data
    environment:
      FEED_RELEASE: ${FEED_RELEASE:-24.10}
      KEEP_ALIVE: "1"
    volumes:
      - scap_data_vol:/mnt
    healthcheck:
      test: ["CMD-SHELL", "test -n \"$(ls -A /mnt 2>/dev/null)\""]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 30s
    restart: unless-stopped

  cert-bund-data:
    image: registry.community.greenbone.net/community/cert-bund-data
    environment:
      FEED_RELEASE: ${FEED_RELEASE:-24.10}
      KEEP_ALIVE: "1"
    volumes:
      - cert_data_vol:/mnt
    healthcheck:
      test: ["CMD-SHELL", "test -n \"$(ls -A /mnt 2>/dev/null)\""]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 30s
    restart: unless-stopped

  dfn-cert-data:
    image: registry.community.greenbone.net/community/dfn-cert-data
    depends_on:
      cert-bund-data:
        condition: service_healthy
    environment:
      FEED_RELEASE: ${FEED_RELEASE:-24.10}
      KEEP_ALIVE: "1"
    volumes:
      - cert_data_vol:/mnt
    healthcheck:
      test: ["CMD-SHELL", "test -n \"$(ls -A /mnt 2>/dev/null)\""]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 30s
    restart: unless-stopped

  data-objects:
    image: registry.community.greenbone.net/community/data-objects
    environment:
      FEED_RELEASE: ${FEED_RELEASE:-24.10}
      KEEP_ALIVE: "1"
    volumes:
      - data_objects_vol:/mnt
    healthcheck:
      test: ["CMD-SHELL", "test -n \"$(ls -A /mnt 2>/dev/null)\""]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 30s
    restart: unless-stopped

  report-formats:
    image: registry.community.greenbone.net/community/report-formats
    depends_on:
      data-objects:
        condition: service_healthy
    environment:
      FEED_RELEASE: ${FEED_RELEASE:-24.10}
      KEEP_ALIVE: "1"
    volumes:
      - report_formats_vol:/mnt
    healthcheck:
      test: ["CMD-SHELL", "test -n \"$(ls -A /mnt 2>/dev/null)\""]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 30s
    restart: unless-stopped

  gpg-data:
    image: registry.community.greenbone.net/community/gpg-data
    volumes:
      - gpg_data_vol:/mnt
    restart: "no"

  redis:
    image: registry.community.greenbone.net/community/redis-server
    volumes:
      - redis_socket_vol:/run/redis/
    healthcheck:
      test: ["CMD-SHELL", "test -S /run/redis/redis.sock"]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 10s
    restart: unless-stopped

  postgres:
    image: registry.community.greenbone.net/community/pg-gvm:stable
    depends_on:
      pg-gvm-migrator:
        condition: service_completed_successfully
    volumes:
      - psql_data_vol:/var/lib/postgresql
      - psql_socket_vol:/var/run/postgresql
    healthcheck:
      test: ["CMD-SHELL", "test -S /var/run/postgresql/.s.PGSQL.5432"]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 15s
    restart: unless-stopped

  pg-gvm-migrator:
    image: registry.community.greenbone.net/community/pg-gvm-migrator:stable
    volumes:
      - psql_data_vol:/var/lib/postgresql
      - psql_socket_vol:/var/run/postgresql
    restart: "no"

  configure-openvas:
    image: registry.community.greenbone.net/community/openvas-scanner:stable
    environment:
      LOG_LEVEL: ${OPENVAS_LOG_LEVEL:-INFO}
    volumes:
      - openvas_data_vol:/mnt
      - openvas_log_data_vol:/var/log/openvas
    command:
      - /bin/sh
      - -c
      - |
        printf "table_driven_lsc = yes\nopenvasd_server = http://openvasd:80\n" > /mnt/openvas.conf
        sed "s/level = INFO/level = $${LOG_LEVEL}/" /etc/openvas/openvas_log.conf > /mnt/openvas_log.conf
        touch /var/log/openvas/openvas.log
        chmod 666 /var/log/openvas/openvas.log
    depends_on:
      gpg-data:
        condition: service_completed_successfully
    restart: "no"

  openvas-scanner:
    image: registry.community.greenbone.net/community/openvas-scanner:stable
    command:
      - /bin/sh
      - -c
      - |
        cat /etc/openvas/openvas.conf
        tail -F /var/log/openvas/openvas.log
    volumes:
      - openvas_data_vol:/etc/openvas
      - openvas_log_data_vol:/var/log/openvas
    depends_on:
      configure-openvas:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "test -f /etc/openvas/openvas.conf && test -f /var/log/openvas/openvas.log"]
      interval: 20s
      timeout: 5s
      retries: 20
      start_period: 15s
    restart: unless-stopped

  openvasd:
    image: registry.community.greenbone.net/community/openvas-scanner:stable
    environment:
      OPENVASD_MODE: service_notus
      GNUPGHOME: /etc/openvas/gnupg
      LISTENING: 0.0.0.0:80
      OPENVASD_LOG: /var/log/openvas/openvasd.log
    command:
      - /bin/sh
      - -c
      - /usr/local/bin/openvasd
    volumes:
      - gpg_data_vol:/etc/openvas/gnupg
      - openvas_data_vol:/etc/openvas
      - openvas_log_data_vol:/var/log/openvas
      - notus_data_vol:/var/lib/notus
    depends_on:
      configure-openvas:
        condition: service_completed_successfully
      gpg-data:
        condition: service_completed_successfully
      vulnerability-tests:
        condition: service_healthy
      notus-data:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "test -f /var/log/openvas/openvasd.log"]
      interval: 20s
      timeout: 5s
      retries: 20
      start_period: 20s
    restart: unless-stopped

  ospd-openvas:
    image: registry.community.greenbone.net/community/ospd-openvas:stable
    hostname: ospd-openvas.local
    cap_add:
      - NET_ADMIN
      - NET_RAW
    security_opt:
      - seccomp=unconfined
      - apparmor=unconfined
    command:
      - /usr/local/bin/ospd-openvas
      - --foreground
      - --unix-socket=/run/ospd/ospd-openvas.sock
      - --log-file=/var/log/gvm/ospd-openvas.log
      - --lock-file-dir=/run
      - --socket-mode=0o777
      - --mqtt-broker-address=mosquitto
      - --openvasd-server=http://openvasd:80
    volumes:
      - gpg_data_vol:/etc/openvas/gnupg
      - vt_data_vol:/var/lib/openvas/plugins
      - notus_data_vol:/var/lib/notus
      - ospd_openvas_socket_vol:/run/ospd
      - redis_socket_vol:/run/redis/
      - openvas_data_vol:/etc/openvas/
      - openvas_log_data_vol:/var/log/openvas
    depends_on:
      redis:
        condition: service_healthy
      openvas-scanner:
        condition: service_started
      openvasd:
        condition: service_started
      gpg-data:
        condition: service_completed_successfully
      configure-openvas:
        condition: service_completed_successfully
      vulnerability-tests:
        condition: service_healthy
      notus-data:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "test -S /run/ospd/ospd-openvas.sock"]
      interval: 20s
      timeout: 5s
      retries: 30
      start_period: 30s
    restart: unless-stopped

  gvmd:
    image: registry.community.greenbone.net/community/gvmd:stable
    depends_on:
      postgres:
        condition: service_healthy
      data-objects:
        condition: service_healthy
      vulnerability-tests:
        condition: service_healthy
      notus-data:
        condition: service_healthy
      scap-data:
        condition: service_healthy
      cert-bund-data:
        condition: service_healthy
      dfn-cert-data:
        condition: service_healthy
      report-formats:
        condition: service_healthy
      ospd-openvas:
        condition: service_healthy
    volumes:
      - gvmd_data_vol:/var/lib/gvm
      - scap_data_vol:/var/lib/gvm/scap-data
      - cert_data_vol:/var/lib/gvm/cert-data
      - data_objects_vol:/var/lib/gvm/data-objects/gvmd
      - vt_data_vol:/var/lib/openvas/plugins
      - report_formats_vol:/var/lib/gvm/gvmd/report_formats
      - gvmd_socket_vol:/run/gvmd
      - ospd_openvas_socket_vol:/run/ospd
      - psql_socket_vol:/var/run/postgresql
    healthcheck:
      test: ["CMD-SHELL", "test -S /run/gvmd/gvmd.sock"]
      interval: 20s
      timeout: 5s
      retries: 30
      start_period: 30s
    restart: unless-stopped

  gsad:
    image: registry.community.greenbone.net/community/gsa:stable
    depends_on:
      gvmd:
        condition: service_healthy
    ports:
      - "${GSAD_BIND:-0.0.0.0}:${GSAD_PORT:-9392}:80"
    volumes:
      - gvmd_socket_vol:/run/gvmd
    healthcheck:
      test: ["CMD-SHELL", "test -S /run/gvmd/gvmd.sock"]
      interval: 20s
      timeout: 5s
      retries: 20
      start_period: 20s
    restart: unless-stopped

volumes:
  gpg_data_vol:
  cert_data_vol:
  data_objects_vol:
  vt_data_vol:
  notus_data_vol:
  scap_data_vol:
  report_formats_vol:
  openvas_data_vol:
  openvas_log_data_vol:
  gvmd_data_vol:
  redis_socket_vol:
  ospd_openvas_socket_vol:
  gvmd_socket_vol:
  psql_data_vol:
  psql_socket_vol:
