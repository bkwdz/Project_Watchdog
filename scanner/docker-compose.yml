name: watchdog-scanner

services:
  vulnerability-tests:
    image: registry.community.greenbone.net/community/vulnerability-tests:latest
    environment:
      KEEP_ALIVE: "1"
      FEED_RELEASE: "24.10"
    mem_limit: 768m
    volumes:
      - openvas_vt_data:/mnt
    healthcheck:
      test: ["CMD-SHELL", "test -n \"$(ls -A /mnt 2>/dev/null)\""]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 30s
    networks:
      - watchdog-internal
    restart: unless-stopped

  notus-data:
    image: registry.community.greenbone.net/community/notus-data:latest
    environment:
      KEEP_ALIVE: "1"
    mem_limit: 768m
    volumes:
      - notus_data:/mnt
    healthcheck:
      test: ["CMD-SHELL", "test -n \"$(ls -A /mnt 2>/dev/null)\""]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 30s
    networks:
      - watchdog-internal
    restart: unless-stopped

  scap-data:
    image: registry.community.greenbone.net/community/scap-data:latest
    environment:
      KEEP_ALIVE: "1"
    mem_limit: 768m
    volumes:
      - scap_data:/mnt
    healthcheck:
      test: ["CMD-SHELL", "test -n \"$(ls -A /mnt 2>/dev/null)\""]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 30s
    networks:
      - watchdog-internal
    restart: unless-stopped

  cert-bund-data:
    image: registry.community.greenbone.net/community/cert-bund-data:latest
    environment:
      KEEP_ALIVE: "1"
    mem_limit: 768m
    volumes:
      - cert_data:/mnt
    healthcheck:
      test: ["CMD-SHELL", "test -n \"$(ls -A /mnt 2>/dev/null)\""]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 30s
    networks:
      - watchdog-internal
    restart: unless-stopped

  dfn-cert-data:
    image: registry.community.greenbone.net/community/dfn-cert-data:latest
    environment:
      KEEP_ALIVE: "1"
    mem_limit: 768m
    volumes:
      - cert_data:/mnt
    depends_on:
      cert-bund-data:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "test -n \"$(ls -A /mnt 2>/dev/null)\""]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 30s
    networks:
      - watchdog-internal
    restart: unless-stopped

  data-objects:
    image: registry.community.greenbone.net/community/data-objects:latest
    environment:
      KEEP_ALIVE: "1"
      FEED_RELEASE: "24.10"
    mem_limit: 768m
    volumes:
      - data_objects:/mnt
    healthcheck:
      test: ["CMD-SHELL", "test -d /mnt/scan-configs -a -d /mnt/port-lists"]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 30s
    networks:
      - watchdog-internal
    restart: unless-stopped

  report-formats:
    image: registry.community.greenbone.net/community/report-formats:latest
    environment:
      KEEP_ALIVE: "1"
      FEED_RELEASE: "24.10"
    mem_limit: 768m
    volumes:
      - data_objects:/mnt
    depends_on:
      data-objects:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "test -d /mnt/report-formats"]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 30s
    networks:
      - watchdog-internal
    restart: unless-stopped

  gpg-data:
    image: registry.community.greenbone.net/community/gpg-data:latest
    mem_limit: 256m
    restart: "no"
    volumes:
      - gpg_data:/mnt
    networks:
      - watchdog-internal

  redis-server:
    image: registry.community.greenbone.net/community/redis-server:latest
    mem_limit: 512m
    volumes:
      - redis_data:/data
      - redis_socket:/run/redis
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -s /run/redis/redis.sock ping | grep PONG"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 10s
    networks:
      - watchdog-internal
    restart: unless-stopped

  pg-gvm-migrator:
    image: registry.community.greenbone.net/community/pg-gvm-migrator:stable
    mem_limit: 1g
    restart: "no"
    volumes:
      - pg_data:/var/lib/postgresql
      - pg_socket:/var/run/postgresql
    networks:
      - watchdog-internal

  pg-gvm:
    image: registry.community.greenbone.net/community/pg-gvm:stable
    mem_limit: 1g
    restart: unless-stopped
    volumes:
      - pg_data:/var/lib/postgresql
      - pg_socket:/var/run/postgresql
    depends_on:
      pg-gvm-migrator:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "test -S /var/run/postgresql/.s.PGSQL.5432"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 15s
    networks:
      - watchdog-internal

  openvas-scanner:
    image: registry.community.greenbone.net/community/openvas-scanner:latest
    environment:
      OPENVASD_MODE: service_notus
      LISTENING: 0.0.0.0:9390
      OPENVASD_LOG: /var/log/openvas/openvasd.log
      GNUPGHOME: /etc/openvas/gnupg
    mem_limit: 3g
    command:
      - /bin/sh
      - -c
      - |
        touch /var/log/openvas/openvas.log /var/log/openvas/openvasd.log
        chmod 666 /var/log/openvas/openvas.log /var/log/openvas/openvasd.log
        exec /usr/local/bin/openvasd
    volumes:
      - openvas_data:/etc/openvas
      - openvas_vt_data:/var/lib/openvas/plugins
      - notus_data:/var/lib/notus
      - openvas_logs:/var/log/openvas
      - redis_socket:/run/redis
      - gpg_data:/etc/openvas/gnupg
    depends_on:
      redis-server:
        condition: service_healthy
      vulnerability-tests:
        condition: service_healthy
      notus-data:
        condition: service_healthy
      gpg-data:
        condition: service_completed_successfully
      configure-openvas:
        condition: service_completed_successfully
    networks:
      - watchdog-internal
    restart: unless-stopped

  configure-openvas:
    image: registry.community.greenbone.net/community/openvas-scanner:latest
    mem_limit: 512m
    command:
      - /bin/sh
      - -c
      - |
        printf "table_driven_lsc = yes\nopenvasd_server = http://openvas-scanner:9390\n" > /mnt/openvas.conf
        sed "s/127/128/" /etc/openvas/openvas_log.conf | sed "s/gvm/openvas/" > /mnt/openvas_log.conf
        chmod 644 /mnt/openvas.conf /mnt/openvas_log.conf
        touch /var/log/openvas/openvas.log
        chmod 666 /var/log/openvas/openvas.log
    volumes:
      - openvas_data:/mnt
      - openvas_logs:/var/log/openvas
    restart: "no"
    networks:
      - watchdog-internal

  ospd-openvas:
    image: registry.community.greenbone.net/community/ospd-openvas:latest
    hostname: ospd-openvas.local
    cap_add:
      - NET_ADMIN
      - NET_RAW
    security_opt:
      - seccomp=unconfined
      - apparmor=unconfined
    command:
      - /bin/sh
      - -c
      - |
        /usr/local/bin/ospd-openvas \
          -f \
          -u /run/ospd/ospd-openvas.sock \
          -m 666 \
          --notus-feed-dir=/var/lib/notus/advisories \
          --openvasd-server=http://openvas-scanner:9390
    mem_limit: 2g
    volumes:
      - gpg_data:/etc/openvas/gnupg
      - openvas_data:/etc/openvas
      - openvas_vt_data:/var/lib/openvas/plugins
      - notus_data:/var/lib/notus
      - openvas_logs:/var/log/openvas
      - redis_socket:/run/redis
      - ospd_socket:/run/ospd
    depends_on:
      redis-server:
        condition: service_healthy
      openvas-scanner:
        condition: service_started
      vulnerability-tests:
        condition: service_healthy
      notus-data:
        condition: service_healthy
      gpg-data:
        condition: service_completed_successfully
      configure-openvas:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import socket; s=socket.socket(socket.AF_UNIX, socket.SOCK_STREAM); s.settimeout(2); s.connect('/run/ospd/ospd-openvas.sock'); s.close()\""]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 30s
    networks:
      - watchdog-internal
    restart: unless-stopped

  gvmd:
    image: registry.community.greenbone.net/community/gvmd:stable
    environment:
      USER: ${GVMD_USER:-admin}
      PASSWORD: ${GVMD_PASSWORD:-admin}
      GVMD_ARGS: ${GVMD_ARGS:--f --listen-mode=666}
    mem_limit: 2g
    volumes:
      - gvmd_data:/var/lib/gvm
      - scap_data:/var/lib/gvm/scap-data
      - cert_data:/var/lib/gvm/cert-data
      - data_objects:/var/lib/gvm/data-objects/gvmd
      - openvas_vt_data:/var/lib/openvas/plugins
      - pg_data:/var/lib/postgresql
      - gvmd_socket:/run/gvmd
      - ospd_socket:/run/ospd
      - pg_socket:/var/run/postgresql
    depends_on:
      pg-gvm:
        condition: service_started
      ospd-openvas:
        condition: service_healthy
      scap-data:
        condition: service_healthy
      cert-bund-data:
        condition: service_healthy
      dfn-cert-data:
        condition: service_healthy
      data-objects:
        condition: service_healthy
      report-formats:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "test -S /run/gvmd/gvmd.sock"]
      interval: 15s
      timeout: 5s
      retries: 30
      start_period: 45s
    networks:
      - watchdog-internal
    restart: unless-stopped

volumes:
  openvas_vt_data:
  notus_data:
  scap_data:
  cert_data:
  data_objects:
  openvas_logs:
  openvas_data:
  redis_data:
  redis_socket:
  gpg_data:
  pg_data:
  pg_socket:
  gvmd_data:
  gvmd_socket:
    external: true
    name: watchdog-gvmd-socket
  ospd_socket:

networks:
  watchdog-internal:
    external: true
    name: watchdog-internal
